name: Changesets Release

on:
  push:
    branches:
      - main

concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          # This makes the Actions fetch all Git history so that Changesets can generate changelogs with the correct commits
          fetch-depth: 0

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'yarn'

      - run: yarn

      - name: Create Release Pull Request or Publish
        id: changesets
        uses: changesets/action@v1
        with:
          # For private packages, this will not publish to npm but we keep the script for consistency
          publish: yarn release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
      
      - name: Create Tags and GitHub Releases for Private Packages
        if: steps.changesets.outputs.published == 'false' && steps.changesets.outputs.hasChangesets == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # This script creates git tags and GitHub releases for versioned private packages
          # It runs when there are no changesets (meaning a "Version Packages" PR was just merged)
          
          echo "Detecting packages with new versions..."
          
          # Find all package.json files (excluding node_modules)
          for pkg_json in $(find . -name "package.json" -not -path "*/node_modules/*" -not -path "./.boilerplates/*"); do
            pkg_dir=$(dirname "$pkg_json")
            changelog="$pkg_dir/CHANGELOG.md"
            
            # Check if CHANGELOG exists
            if [ ! -f "$changelog" ]; then
              continue
            fi
            
            # Extract package name and version
            pkg_name=$(node -p "require('$pkg_json').name")
            pkg_version=$(node -p "require('$pkg_json').version")
            
            # Skip if package name or version is undefined
            if [ "$pkg_name" == "undefined" ] || [ "$pkg_version" == "undefined" ]; then
              continue
            fi
            
            # Create tag name
            tag_name="${pkg_name}@${pkg_version}"
            
            # Check if tag already exists
            if git rev-parse "$tag_name" >/dev/null 2>&1; then
              echo "Tag $tag_name already exists, skipping..."
              continue
            fi
            
            echo "Creating tag $tag_name..."
            git tag "$tag_name"
            git push origin "$tag_name"
            
            # Extract changelog for this version
            echo "Extracting changelog for $tag_name..."
            changelog_content=$(awk -v ver="## $pkg_version" '
              $0 ~ ver {flag=1; next} 
              /^## / && flag {exit} 
              flag {print}
            ' "$changelog")
            
            # Create GitHub release
            echo "Creating GitHub release for $tag_name..."
            gh release create "$tag_name" \
              --title "$tag_name" \
              --notes "$changelog_content" \
              --verify-tag
          done

