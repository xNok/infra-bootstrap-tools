---
- name: Ensure dependencies are installed
  ansible.builtin.apt:
    name:
      - apt-transport-https
      - gnupg
      - curl
      - python3-pip
      - python3-kubernetes
    state: present

- name: Add Helm GPG key
  ansible.builtin.shell: |
    set -o pipefail
    curl -fsSL https://packages.buildkite.com/helm-linux/helm-debian/gpgkey | gpg --dearmor -o /usr/share/keyrings/helm.gpg
  args:
    creates: /usr/share/keyrings/helm.gpg

- name: Add Helm apt repository
  ansible.builtin.apt_repository:
    repo: "deb [signed-by=/usr/share/keyrings/helm.gpg] https://packages.buildkite.com/helm-linux/helm-debian/any/ any main"
    filename: helm-stable-debian
    state: present

- name: Install Helm
  ansible.builtin.apt:
    name: helm
    state: present
    update_cache: true

- name: Install Kubernetes Python Library
  ansible.builtin.pip:
    name: kubernetes
    state: present
    break_system_packages: true

- name: Install Flux Operator
  kubernetes.core.helm:
    name: flux-operator
    chart_ref: oci://ghcr.io/controlplaneio-fluxcd/charts/flux-operator
    release_namespace: flux-system
    create_namespace: true
    state: present
    wait: true
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

- name: Create GHCR pull secret
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: flux-system
        namespace: flux-system
      type: kubernetes.io/dockerconfigjson
      stringData:
        .dockerconfigjson: "{{ docker_config | to_json }}"
  vars:
    docker_config:
      auths:
        ghcr.io:
          username: "{{ k3s_flux_bootstrap_github_user }}"
          password: "{{ k3s_flux_bootstrap_github_token }}"
          auth: "{{ (k3s_flux_bootstrap_github_user + ':' + k3s_flux_bootstrap_github_token) | b64encode }}"
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

- name: Apply FluxInstance
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', role_path + '/templates/flux-instance.yaml.j2') | from_yaml }}"
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

- name: Wait for Flux to reconcile
  ansible.builtin.command: kubectl -n flux-system wait --for=condition=ready --timeout=300s fluxinstance/flux
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  changed_when: false
