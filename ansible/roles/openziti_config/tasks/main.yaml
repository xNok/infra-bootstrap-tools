---
- name: Login to Ziti Controller
  ansible.builtin.shell: |
    ziti edge login {{ openziti_controller_url }} -u {{ openziti_admin_username }} -p {{ openziti_admin_password }} -y
  register: ziti_login
  changed_when: false

- name: Create Global Edge Router Policies
  ansible.builtin.shell: |
    ziti edge create edge-router-policy all-endpoints --edge-router-roles '#all' --identity-roles '#all' || true
    ziti edge create service-edge-router-policy all-services --edge-router-roles '#all' --service-roles '#all' || true
  ignore_errors: true

- name: Configure Services
  include_tasks: service_setup.yml
  loop: "{{ openziti_services }}"
  loop_control:
    loop_var: service_item

- name: Create Client Identities
  ansible.builtin.shell: |
    ziti edge create identity user "{{ item }}" -o "/tmp/{{ item }}.jwt" -a "clients" || true
  args:
    creates: "/tmp/{{ item }}.jwt"
  loop: "{{ openziti_identities }}"
  register: create_identities

- name: Fetch Identity JWTs
  ansible.builtin.fetch:
    src: "/tmp/{{ item }}.jwt"
    dest: "{{ playbook_dir }}/{{ item }}.jwt"
    flat: true
  loop: "{{ openziti_identities }}"
