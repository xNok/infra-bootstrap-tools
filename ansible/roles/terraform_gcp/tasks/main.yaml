#################################################
# OR INFRA Role: terraform-gcp
#################################################
---

- name: Copy Backend Configuration
  when: not terraform_gcp_destroy | bool
  ansible.builtin.copy:
    src: "{{ terraform_gcp_backend_config }}"
    dest: "{{ role_path }}/terraform/backend.tf"
    mode: '0644'

- name: Provision GCP Infra
  community.general.terraform:
    project_path: '{{ role_path }}/terraform'
    state: "{{ 'absent' if terraform_gcp_destroy | bool else 'present' }}"
    force_init: true
  register: terraform_gcp_result

- name: Create Ansible Inventory
  when: not terraform_gcp_destroy | bool
  ansible.builtin.template:
    src: "{{ role_path }}/assets/inventory.tpl"
    dest: "{{ terraform_gcp_inventory_path }}/gcp"
    mode: '0644'
  vars:
    prefix: "{{ terraform_gcp_inventory_prefix }}"
    user: "{{ terraform_gcp_inventory_user }}"
    nodes: "{{ terraform_gcp_result.outputs.nodes_ips.value }}"
    managers: "{{ terraform_gcp_result.outputs.managers_ips.value }}"

- name: Delete Ansible Inventory on Destroy
  when: terraform_gcp_destroy | bool
  ansible.builtin.file:
    path: "{{ terraform_gcp_inventory_path }}/gcp"
    state: 'absent'

- name: Make sure known_hosts exists
  when: not terraform_gcp_destroy | bool
  ansible.builtin.file:
    path: "{{ lookup('env', 'HOME') }}/.ssh/known_hosts"
    state: touch
    mode: '0600'

- name: Add inventory to known_hosts
  when: not terraform_gcp_destroy | bool
  ansible.builtin.known_hosts:
    name: "{{ item.key }}"
    key: "{{ item.key }} {{ item.value }}"
  loop: "{{ terraform_gcp_result.outputs.known_hosts.value | dict2items }}"

- name: Refresh Ansible Inventory
  ansible.builtin.meta: refresh_inventory
